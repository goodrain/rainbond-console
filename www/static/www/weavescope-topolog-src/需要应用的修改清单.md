# 需要应用的修改清单

## 概述
本项目需要实现节点连线功能，包括创建连线、删除连线、右键菜单等功能。

## 已完成的工作总结

### 1. 核心功能实现
- ✅ 节点右键菜单（创建连线、删除节点）
- ✅ 连线右键菜单（删除连线）
- ✅ 连线创建流程（拖动创建）
- ✅ 连线删除功能
- ✅ 父窗口回调（onEdgeCreated, onEdgeDeleted）
- ✅ 节点数据自动刷新

### 2. 关键修改文件列表

由于文件被恢复，所有修改都需要重新应用。关键文件包括：

#### Action Types (常量定义)
**文件**: `app/scripts/constants/action-types.js`
需要添加的常量：
```javascript
START_EDGE_CREATE: null,
UPDATE_EDGE_CREATE: null,
FINISH_EDGE_CREATE: null,
CANCEL_EDGE_CREATE: null,
SELECT_EDGE: null,
DESELECT_EDGE: null,
DELETE_EDGE: null,
SHOW_NODE_CONTEXT_MENU: null,
HIDE_NODE_CONTEXT_MENU: null,
SHOW_EDGE_CONTEXT_MENU: null,
HIDE_EDGE_CONTEXT_MENU: null,
```

#### Actions (行为实现)
**文件**: `app/scripts/actions/app-actions.js`
需要添加的函数：
- `startEdgeCreate(sourceNodeId, sourcePosition)`
- `updateEdgeCreate(mousePosition)`
- `finishEdgeCreate(targetNodeId, targetPosition)` - 包含父窗口回调和数据刷新
- `cancelEdgeCreate()`
- `selectEdge(edgeId)`
- `deselectEdge()`
- `deleteEdge(edgeId)` - 包含父窗口回调和数据刷新
- `showNodeContextMenu(nodeId, nodeLabel, position)`
- `hideNodeContextMenu()`
- `showEdgeContextMenu(edgeId, position)`
- `hideEdgeContextMenu()`

#### Reducer (状态管理)
**文件**: `app/scripts/reducers/root.js`
需要在 initialState 中添加：
```javascript
edgeCreation: makeMap({
  isCreating: false,
  sourceNodeId: null,
  sourcePosition: makeMap({ x: 0, y: 0 }),
  currentMousePosition: makeMap({ x: 0, y: 0 })
}),
selectedEdgeId: null,
customEdges: makeOrderedMap(),
nodeContextMenu: makeMap({
  visible: false,
  nodeId: null,
  nodeLabel: null,
  position: makeMap({ x: 0, y: 0 })
}),
edgeContextMenu: makeMap({
  visible: false,
  edgeId: null,
  position: makeMap({ x: 0, y: 0 })
})
```

需要添加的 case 处理：
- `ActionTypes.START_EDGE_CREATE`
- `ActionTypes.UPDATE_EDGE_CREATE`
- `ActionTypes.FINISH_EDGE_CREATE`
- `ActionTypes.CANCEL_EDGE_CREATE`
- `ActionTypes.SELECT_EDGE`
- `ActionTypes.DESELECT_EDGE`
- `ActionTypes.DELETE_EDGE`
- `ActionTypes.SHOW_NODE_CONTEXT_MENU`
- `ActionTypes.HIDE_NODE_CONTEXT_MENU`
- `ActionTypes.SHOW_EDGE_CONTEXT_MENU`
- `ActionTypes.HIDE_EDGE_CONTEXT_MENU`

#### 组件创建
需要创建以下新组件：

1. **文件**: `app/scripts/components/edge-create-overlay.js`
   - 连线创建时的视觉反馈组件
   - 显示从源节点到鼠标位置的临时连线

2. **文件**: `app/scripts/components/node-context-menu.js`
   - 节点右键菜单组件
   - 提供"创建连线"和"删除节点"选项

3. **文件**: `app/scripts/components/edge-context-menu.js`
   - 连线右键菜单组件
   - 提供"删除连线"选项

#### 图表渲染修改
**文件**: `app/scripts/charts/nodes-chart.js`
- 集成连线创建覆盖层
- 集成右键菜单组件
- 连接 Redux actions

**文件**: `app/scripts/charts/nodes-chart-elements.js`
- 添加自定义连线渲染逻辑
- 使用节点的 x, y 属性（不是 position 对象）
- 添加位置未定义时的保护

**文件**: `app/scripts/charts/node.js`
- 添加右键点击事件处理
- 触发节点右键菜单

**文件**: `app/scripts/charts/edge.js` 或 `edge-container.js`
- 添加右键点击事件处理
- 触发连线右键菜单

### 3. 关键问题修复

1. **状态访问错误修复**
   - 问题：使用了不存在的 `edgeCreateFrom` 状态
   - 修复：改为 `edgeCreation`

2. **节点位置属性修复**
   - 问题：尝试访问 `node.get('position').get('x')`
   - 修复：直接访问 `node.get('x')` 和 `node.get('y')`

3. **数据刷新**
   - 在 `finishEdgeCreate` 和 `deleteEdge` 中调用 `getNodesDelta`
   - 确保拓扑图显示最新的连线关系

### 4. 父窗口回调接口

```javascript
// 创建连线时调用
window.parent.onEdgeCreated(edgeData)

// 删除连线时调用
window.parent.onEdgeDeleted(edgeData)

// edgeData 格式：
{
  edgeId: string,
  sourceNodeId: string,
  targetNodeId: string,
  sourceServiceAlias: string,
  targetServiceAlias: string,
  sourceServiceCname: string,
  targetServiceCname: string,
  sourceShape: string,
  targetShape: string,
  sourceNode: object,
  targetNode: object
}
```

## 下一步操作

1. 等待 npm install 完成
2. 逐个应用上述修改
3. 运行构建脚本 `./build.sh`
4. 测试所有功能

## 测试检查清单

- [ ] 右键点击节点，显示菜单
- [ ] 选择"创建连线"，可以连接到另一个节点
- [ ] 连线创建成功，调用父窗口 API
- [ ] 右键点击连线，显示菜单
- [ ] 选择"删除连线"，连线被删除
- [ ] 连线删除成功，调用父窗口 API
- [ ] 连线创建/删除后，节点数据自动刷新
- [ ] 所有 console.log 已清理
