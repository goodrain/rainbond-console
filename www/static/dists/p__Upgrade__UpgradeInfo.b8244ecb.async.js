(window["webpackJsonp"]=window["webpackJsonp"]||[]).push([[68],{TAMF:function(e,t,a){"use strict";var r=a("g09b"),s=a("tAuX");Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0,a("+L6B");var l=r(a("2/Rp"));a("Mwp2");var n=r(a("VXEj"));a("jCWc");var d=r(a("kPKH"));a("sRBo");var i=r(a("kaz8"));a("T2oS");var o=r(a("W9HT")),u=r(a("jehZ"));a("14J3");var c=r(a("BMrR"));a("fOrg");var p=r(a("+KLJ"));a("Pwec");var h=r(a("CtXQ"));a("5Dmo");var m=r(a("3S7+"));a("y8nQ");var g=r(a("Vl3Y"));a("OaEy");var _,f,v,y,E=r(a("2fM7")),D=a("MuoO"),x=a("7DNP"),b=s(a("q1tI")),I=r(a("XZXw")),k=a("xpXo"),z=a("vSx2"),S=r(a("4W9V")),C=r(a("QDog")),R=r(a("ywO+")),w=r(a("VZuE")),L=E.default.Option,U=(_=g.default.create(),f=(0,D.connect)(e=>{var t=e.user,a=e.global,r=e.application,s=e.teamControl,l=e.enterprise;return{groupDetail:r.groupDetail||{},currUser:t.pageUser,groups:a.groups||[],currentTeam:s.currentTeam,currentRegionName:s.currentRegionName,currentEnterprise:l.currentEnterprise,currentTeamPermissionsInfo:s.currentTeamPermissionsInfo}}),_(v=f((y=class extends b.PureComponent{constructor(e){var t;super(e),t=this,this.onVersionChange=(e=>{this.props.form.setFieldsValue({upgradeVersions:e}),this.getUpdatedInfo(e)}),this.getUpdatedInfo=function(e){var a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null,r=t.props.dispatch,s=t.state.upgradeDetail,l=t.getParameter();s&&s.record&&(l.marketName=s.record.market_name),t.setState({upgradeListLoading:!0}),l.version=e,r({type:"global/CloudAppUpdatedInfo",payload:l,callback:e=>{if(e&&200===e.status_code){var r=[];e.list&&(r=e.list.map(e=>{return"add"==e.service.type?e.service.service_key:e.service.can_upgrade?e.service.service_id:null})),t.setState({upgradeInfo:e.list||[],upgradeListLoading:!1,upgrade_component_ids:r,selectVersion:!0},()=>{a&&a(),e.list.length>0&&t.handleSelectComponent(e.list[0])})}}})},this.getParameter=(()=>{var e=this.props.match.params,t=e.teamName,a=e.regionName,r=e.appID,s=e.recordID,l=e.upgradeGroupID,n=this.props.location.query.app_id;return{team_name:t,region_name:a,group_id:r,record_id:s,upgradeGroupID:l,app_model_key:n}}),this.getUpgradeRecordsInfo=(()=>{var e=this.getParameter(),t=e.team_name,a=e.group_id,r=e.upgradeGroupID,s=this.props.dispatch,l=this.state,n=l.upgradeDetail,d=l.upgradeInfo;s({type:"global/CloudAppUpdateRecordsInfo",payload:{team_name:t,group_id:a,upgrade_group_id:r,record_id:n.record.ID},callback:e=>{if(e&&200===e.status_code){var t=e.bean,a={},r={};t.service_record&&t.service_record.map(e=>{return a[e.service_id]=e.status,r[e.service_key]=e.status,e});var s=d.map(e=>{var t=e;return e.service.service_id?t.status=a[e.service.service_id]:e.service.service_key&&(t.status=r[e.service.service_key]),t});this.setState({upgradeRecords:t.service_record,upgradeInfo:s,record:t,textState:t.status,upgradeText:w.default.getStatusText(t.status),upgradeLoading:!1,rollbackLoading:!1},()=>{3!=t.status&&5!=t.status&&6!=t.status&&7!=t.status&&8!=t.status&&9!=t.status&&setTimeout(()=>{this.getUpgradeRecordsInfo()},3e3)})}}})}),this.getData=(e=>{var t=this.state.show_component,a=e=>[{title:"",description:b.default.createElement("div",{style:{textAlign:"center",lineHeight:"300px",fontSize:"25px"}},e)}];if(t&&"add"==t.service.type)return a("\u65b0\u589e\u7ec4\u4ef6");if(t){var r=t.service,s=t.upgrade_info;return r&&"add"==r.type?a("\u65b0\u589e\u7ec4\u4ef6"):s&&r.have_change?this.setData(s):a("\u7ec4\u4ef6\u65e0\u53d8\u66f4")}return a(e?"\u8bf7\u9009\u62e9\u8981\u5347\u7ea7\u7684\u7248\u672c":"\u6682\u65e0\u53ef\u5347\u7ea7\u7684\u7248\u672c")}),this.handleAdd=(e=>{return e&&e.add&&e.add.length>0}),this.handleUpd=(e=>{return e&&e.upd&&e.upd.length>0}),this.handleDel=(e=>{return e&&e.delete&&e.delete.length>0}),this.handleData=(e=>{return this.handleAdd(e)||this.handleUpd(e)||this.handleDel(e)}),this.handleBox=((e,t,a,r,s)=>{var l=[];this.handleAdd(t)&&l.push("add"),this.handleUpd(t)&&l.push("upd"),this.handleDel(t)&&l.push("delete");var n={add:"\u65b0\u589e",upd:"\u66f4\u65b0",delete:"\u79fb\u9664"};return b.default.createElement("div",{className:R.default.textzt},l.length>0&&l.map(l=>{return b.default.createElement("div",{key:l},n[l]||"",e,"\uff1a",t[l].map(e=>{var t=r?e[a][r]:e[a];return b.default.createElement("span",{key:e[a]},s&&s[t]||t)}))}))}),this.setData=(e=>{var t=e.probes,a=e.connect_infos,r=e.ports,s=e.volumes,l=e.dep_services,n=e.dep_volumes,d=e.plugins,i=e.envs,o=e.app_config_groups,u=e.component_monitors,c=e.component_graphs,p=e.deploy_version,h=e.plugin_deps,g=[],_=p&&p.is_change,f=this.handleData(l),v=this.handleData(t),y=this.handleAdd(o),E=this.handleData(o),D=this.handleData(c),x=this.handleData(u),I=this.handleData(i),k=this.handleData(h),z=this.handleData(a),S=this.handleData(d),C=this.handleData(n),w=this.handleData(r),L=this.handleData(s);function U(e,t){g.push({title:e,description:t})}if(v){var N={liveness:"\u5b58\u6d3b\u63a2\u9488",readiness:"\u5c31\u7eea\u63a2\u9488"};U("\u5065\u5eb7\u68c0\u6d4b",this.handleBox(null,t,"mode",null,N))}return _&&U("\u6e90\u7ec4\u4ef6\u6784\u5efa\u7248\u672c",b.default.createElement("div",{className:R.default.textzt},"\u4ece ",b.default.createElement("span",null,p.old)," \u53d8\u66f4\u4e3a",b.default.createElement("span",null,p.new))),z&&U("\u8fde\u63a5\u4fe1\u606f",this.handleBox(null,a,"attr_name")),k&&U("\u63d2\u4ef6",this.handleBox(null,h,"plugin","plugin_alias")),I&&U("\u73af\u5883\u53d8\u91cf",this.handleBox(null,i,"attr_name")),w&&U("\u7aef\u53e3",this.handleBox(null,r,"container_port")),L&&U("\u5b58\u50a8",this.handleBox("\u5b58\u50a8\u6302\u8f7d",s,"volume_name")),f&&U("\u4f9d\u8d56\u7ec4\u4ef6",b.default.createElement("div",null,l.add&&l.add.length>0&&b.default.createElement("div",{className:R.default.textzt},"\u65b0\u589e\u5bf9",l.add.map(e=>{return b.default.createElement("span",{key:e.service_id},e.service_cname)}),"\u7ec4\u4ef6\u7684\u4f9d\u8d56"),l.del&&l.del.length>0&&b.default.createElement("div",{className:R.default.textzt},"\u79fb\u9664\u5bf9",l.del.map(e=>{return b.default.createElement("span",{key:e.service_id},e.service_cname)}),"\u7ec4\u4ef6\u7684\u4f9d\u8d56"))),C&&U("\u4f9d\u8d56\u7684\u5b58\u50a8",this.handleBox("\u5b58\u50a8\u6302\u8f7d",n,"mnt_name")),S&&U("\u63d2\u4ef6",this.handleBox(null,d,"plugin_alias")),E&&U("\u5e94\u7528\u914d\u7f6e\u7ec4",b.default.createElement("div",{className:R.default.textzt},y?"\u65b0\u589e":"\u66f4\u65b0","\u5e94\u7528\u914d\u7f6e\u7ec4\uff1a",o[y?"add":"upd"].map(e=>{return b.default.createElement(m.default,{placement:"top",title:e.config_items&&Object.keys(e.config_items).map(t=>{return b.default.createElement("div",null,"".concat(t," : ").concat(e.config_items[t]))})},b.default.createElement("span",{key:e.name},e.name),";")}))),x&&U("\u76d1\u63a7\u70b9",this.handleBox(null,u,"service_show_name")),D&&U("\u76d1\u63a7\u56fe\u8868",this.handleBox(null,c,"title")),g}),this.getUpgradeStatus=(e=>{var t="upgrade"===e.service.type;switch(e.status){case 2:return b.default.createElement(h.default,{type:"sync",style:{color:"#1890ff"},spin:!0});case 8:return b.default.createElement(m.default,{title:"\u6eda\u52a8\u66f4\u65b0\u64cd\u4f5c\u5931\u8d25\uff0c\u8bf7\u524d\u5f80\u7ec4\u4ef6\u9875\u9762\u624b\u52a8\u64cd\u4f5c"},b.default.createElement(h.default,{type:"close",style:{color:"red"}}));case 3:return b.default.createElement(m.default,{title:"\u6210\u529f"},b.default.createElement(h.default,{type:"check",style:{color:"#239B24"}}));default:return t&&e.service.have_change?b.default.createElement(m.default,{title:"\u53ef\u5347\u7ea7"},b.default.createElement(h.default,{type:"up",style:{color:"#239B24"}})):t&&!e.service.can_upgrade?b.default.createElement(m.default,{title:"\u65b0\u7248\u672c\u65e0\u8be5\u7ec4\u4ef6\uff0c\u4e0d\u53ef\u5347\u7ea7"},b.default.createElement(h.default,{type:"info-circle"})):t?b.default.createElement(m.default,{title:"\u7ec4\u4ef6\u65e0\u53d8\u66f4\uff0c\u5347\u7ea7\u53ea\u6539\u53d8\u7248\u672c\u53f7"},b.default.createElement(h.default,{type:"up",style:{color:"#239B24"}})):b.default.createElement(m.default,{title:"\u65b0\u589e\u7ec4\u4ef6"},b.default.createElement(h.default,{type:"plus",style:{color:"#239B24"}}))}}),this.getRecordShow=(()=>{var e=this.state.record;if(!e)return null;var t=e.status,a={1:"\u5347\u7ea7\u4efb\u52a1\u672a\u5f00\u59cb",2:"\u7684\u5347\u7ea7\u4efb\u52a1\u6267\u884c\u4e2d",3:"\u7684\u5347\u7ea7\u4efb\u52a1\u6267\u884c\u6210\u529f",8:"\u7684\u5347\u7ea7\u4efb\u52a1\u6267\u884c\u5931\u8d25",10:"\u7684\u5347\u7ea7\u4efb\u52a1\u6267\u884c\u90e8\u7f72\u5931\u8d25"},r={1:"info",2:"warning",3:"success",8:"error",10:"error"};return[1,2,3,8].includes(t)?b.default.createElement(p.default,{showIcon:!0,type:r[t],message:"".concat(e.group_name," \n          ").concat(1===t?"\u5f53\u524d\u7248\u672c":"\u4ece\u7248\u672c"," \n          ").concat(e.old_version," \n          ").concat(a[t])}):null}),this.returnListPage=(()=>{var e=this.getParameter(),t=e.team_name,a=e.group_id,r=this.props.dispatch;r(x.routerRedux.push("/team/".concat(t,"/region/").concat(C.default.getCurrRegionName(),"/apps/").concat(a,"/upgrade")))}),this.createUpgradeTasks=(e=>{var t=this.props,a=t.form,r=t.dispatch,s=this.state,l=s.upgradeDetail,n=s.upgradeInfo,d=this.getParameter(),i=d.team_name,o=d.group_id,u=d.app_model_key,c=d.upgradeGroupID,p=a.getFieldValue("upgradeVersions"),h=n.filter(t=>{return"add"==t.service.type&&e.services.includes(t.service.service_key)?t.service:e.services.includes(t.service.service_id)?t.service:null});r({type:"global/CloudAppUpdatedTasks",payload:{team_name:i,group_id:o,group_key:u,version:p,services:h,upgrade_record_id:l.record.ID,upgrade_group_id:c},callback:e=>{e&&200===e.status_code&&this.setState({record_id:e.bean.ID},()=>{this.getUpgradeRecordsInfo()})},handleError:e=>{(0,S.default)(e),this.getUpgradeRecordsInfo()}})}),this.handleChangeVersion=((e,t)=>{this.props.form.setFieldsValue({upgradeVersions:e}),this.getUpdatedInfo(e,t)}),this.handleSelectComponent=(e=>{var t=this.state.upgradeInfo;if(e.service.service_id){var a=t.filter(t=>t.service.service_id==e.service.service_id);this.setState({select_component_id:e.service.service_id,show_component:a.length>0?a[0]:null})}else{var r=t.filter(t=>t.service.service_key==e.service.service_key);this.setState({select_component_id:e.service.service_key,show_component:r.length>0?r[0]:null})}}),this.handleSubmit=(()=>{var e=this.props.form,t=this.state.upgradeLoading;e.validateFields((e,a)=>{e||t||this.setState({upgradeLoading:!0},()=>{this.createUpgradeTasks(a)})})}),this.handleRetry=(()=>{var e=this.props,t=e.form,a=e.dispatch,r=this.state,s=r.upgradeLoading,l=r.upgradeDetail;t.validateFields(e=>{e||s||this.setState({upgradeLoading:!0},()=>{var e=this.getParameter(),t=e.team_name,r=e.group_id;a({type:"global/fetchAppRedeploy",payload:{team_name:t,group_id:r,record_id:l.record.ID},callback:e=>{e&&200===e.status_code&&this.setState({record_id:e.bean.ID},()=>{this.getUpgradeRecordsInfo()})},handleError:e=>{(0,S.default)(e),this.getUpgradeRecordsInfo()}})})})}),this.fetchAppDetail=(()=>{var e=this.props.dispatch;this.setState({loadingDetail:!0}),e({type:"application/fetchGroupDetail",payload:this.getParameter(),callback:e=>{e&&200===e.status_code&&this.setState({appDetail:e.bean,loadingDetail:!1})},handleError:t=>{t&&404===t.code&&e(x.routerRedux.push("/team/".concat(C.default.getCurrTeamName(),"/region/").concat(C.default.getCurrRegionName(),"/apps")))}})}),this.fetchUpgradeDetail=(()=>{this.setState({loadingUpgradeDetail:!0}),(0,k.getApplicationUpgradeDetail)(this.getParameter()).then(e=>{if(e&&200===e.status_code){var t=[];e.bean&&e.bean.versions&&(t=e.bean.versions),this.setState({upgradeDetail:e.bean,record:e.bean.record,upgradeText:w.default.getStatusText(e.bean.record.status),textState:e.bean.record.status,loadingUpgradeDetail:!1},()=>{var a=e.bean.record;a.version?this.handleChangeVersion(a.version,()=>{2==a.status&&this.getUpgradeRecordsInfo()}):t.length>0&&this.handleChangeVersion(t[0],()=>{2==a.status&&this.getUpgradeRecordsInfo()})})}return null}).catch(e=>(0,S.default)(e))}),this.state={appDetail:{},type:"",indexs:0,infoObj:{},upgradeVersions:[],upgradeInfo:[],upgrade_info:"",upgradeRecords:[],upgradeText:"\u5347\u7ea7",textState:1,service_id:[],upgradeLoading:!1,rollbackLoading:!1,conshow:!0}}componentDidMount(){this.fetchAppDetail(),this.fetchUpgradeDetail()}render(){var e=this.props,t=e.dispatch,a=e.form,r=this.props,s=r.currentEnterprise,p=r.currentTeam,h=r.currentRegionName,m=a.getFieldDecorator,_=this.getParameter(),f=_.group_id,v=this.state,y=v.select_component_id,D=v.upgradeInfo,k=v.upgradeText,S=v.textState,w=v.upgrade_component_ids,U=v.upgradeListLoading,N=v.upgradeLoading,T=v.appDetail,B=v.loadingDetail,V=v.loadingUpgradeDetail,A=v.upgradeDetail,P=v.selectVersion,G="/team/".concat(C.default.getCurrTeamName(),"/region/").concat(C.default.getCurrRegionName(),"/apps/").concat(f),M={labelCol:{xs:{span:6},sm:{span:6}},wrapperCol:{xs:{span:16},sm:{span:16}}},F=N||2==S,O=[];O=(0,z.createApp)((0,z.createTeam)((0,z.createEnterprise)(O,s),p,h),p,h,{appName:T.group_name,appID:T.group_id});var j=[];A&&A.versions&&A.versions.length>0&&(j=A.versions);var H=j&&j.length>0||V,J=this.getData(H);return b.default.createElement(I.default,{breadcrumbList:O,loading:B,title:"\u5e94\u7528\u5347\u7ea7\u7ba1\u7406",content:"\u5f53\u524d\u5e94\u7528\u5185\u5177\u6709\u4ece\u7ec4\u4ef6\u5e93\u6216\u5e94\u7528\u5546\u5e97\u5b89\u88c5\u800c\u6765\u7684\u7ec4\u4ef6\u65f6\uff0c\u5347\u7ea7\u7ba1\u7406\u529f\u80fd\u53ef\u7528\u3002\u82e5\u5b89\u88c5\u6e90\u7684\u5e94\u7528\u7248\u672c\u6709\u53d8\u66f4\u5219\u53ef\u4ee5\u8fdb\u884c\u5347\u7ea7\u64cd\u4f5c\u3002",extraContent:null},b.default.createElement(o.default,{spinning:V},H&&b.default.createElement(c.default,{style:{marginBottom:"16px"}},this.getRecordShow()),b.default.createElement("div",{style:{padding:"10px",background:"#fff"}},b.default.createElement(c.default,{gutter:24,style:{margin:"0px"}},H&&b.default.createElement(d.default,{xs:{span:6,offset:0},lg:{span:6,offset:0},style:{background:"#fff",borderRight:"1px solid #E8E8E8"},className:R.default.zslbor},b.default.createElement(g.default,{onSubmit:this.handleSubmit},b.default.createElement("div",{className:R.default.zsldis},b.default.createElement(g.default.Item,(0,u.default)({},M,{label:"\u5347\u7ea7\u5230",style:{width:"100%"}}),m("upgradeVersions",{initialValue:j&&j[0],rules:[{required:!1,message:"\u8bf7\u9009\u62e9"}]})(b.default.createElement(E.default,{getPopupContainer:e=>e.parentNode,disabled:1!=S,size:"small",style:{width:120},onChange:this.onVersionChange},j.map(e=>{return b.default.createElement(L,{value:e,key:e},e)}))),b.default.createElement("span",null,"\xa0\xa0\u7248\u672c"))),b.default.createElement("div",{className:R.default.zslcheck},b.default.createElement(g.default.Item,{label:"",style:{width:"100%"}},m("services",{initialValue:w,force:!0,rules:[{required:!0,message:"\u8bf7\u9009\u62e9\u9700\u8981\u5347\u7ea7\u7684\u7ec4\u4ef6"}]})(b.default.createElement(i.default.Group,{className:R.default.zslGroup},U?b.default.createElement("div",{style:{textAlign:"center",width:"100%",marginTop:"32px"}},b.default.createElement(o.default,{size:"large"})):b.default.createElement(c.default,{gutter:24,style:{height:"400px",overflow:"auto"}},D&&D.length>0&&D.map(e=>{var t=e.service;return b.default.createElement(d.default,{span:24,className:"".concat(R.default.zslMt," ").concat(y===e.service.service_id||y===e.service.service_key?R.default.active:""),onClick:()=>{this.handleSelectComponent(e)}},b.default.createElement("div",{style:{width:"100%"}},b.default.createElement(i.default,{value:t.service_id||t.service_key,disabled:!t.can_upgrade,style:{width:"30px"}}),t?t.service_cname:e.service_cname),b.default.createElement("div",null,this.getUpgradeStatus(e)))})))))))),b.default.createElement(d.default,{xs:{span:H?18:24,offset:0},lg:{span:H?18:24,offset:0},style:{background:"#fff"}},b.default.createElement("div",{className:R.default.zslbor},H&&b.default.createElement("div",{className:R.default.zslcen},"\u7ec4\u4ef6\u5c5e\u6027\u53d8\u66f4\u8be6\u60c5"),b.default.createElement(c.default,{gutter:24,style:{margin:"10px 20px 20px",height:"400px",overflow:"auto"}},V?b.default.createElement("div",{style:{textAlign:"center",width:"100%",marginTop:"32px"}},b.default.createElement(o.default,{size:"large"})):b.default.createElement(n.default,{itemLayout:"horizontal",dataSource:J,renderItem:(e,t)=>b.default.createElement(n.default.Item,{key:t},b.default.createElement(n.default.Item.Meta,{title:e.title,description:e.description}))}))))),b.default.createElement(c.default,{gutter:24,className:R.default.customBtn},b.default.createElement(l.default,{style:{marginRight:"16px"},onClick:()=>{this.returnListPage()}},"\u8fd4\u56de"),b.default.createElement(l.default,{type:"primary",onClick:()=>{1!=S&&2!=S&&4!=S?t(x.routerRedux.push(G)):this.handleSubmit()},disabled:!P||F||[6,10].includes(S),loading:F},k),[6,10].includes(S)&&b.default.createElement(l.default,{type:"primary",onClick:this.handleRetry,loading:N,style:{marginLeft:"16px"}},"\u91cd\u8bd5")))))}},v=y))||v)||v);t.default=U},"ywO+":function(e,t,a){e.exports={nameID:"nameID___3MWyA",icon:"icon___3bfHT",iconm:"iconm___1LNTJ",customBtn:"customBtn___1hpm1",versions:"versions___8YZIs",cardList:"cardList___1ljg0",card:"card___16h_h",item:"item___3Gn_t",tabss:"tabss___2D2JS",textzt:"textzt___1N8pe",zsldis:"zsldis___3DeVd",zslbor:"zslbor___3_HY9",zsllbor:"zsllbor___eRQFv",extraImg:"extraImg___9QeuV",newButton:"newButton___RsUib",cardAvatar:"cardAvatar___3mYtw",cardDescription:"cardDescription___1SXU5",pageHeaderContent:"pageHeaderContent___3actc",contentLink:"contentLink___e_Rer",zslcheck:"zslcheck___1hzOS",zslIcon:"zslIcon___sPvd8",zslGroup:"zslGroup___1Z00V",zslMt:"zslMt___29eSS",active:"active___3GZSC",zslcen:"zslcen___1AH2I",zslborl:"zslborl___R02A5",zslborr:"zslborr___24RDp",zslh:"zslh___3TA0Q",listContent:"listContent___1qrLi",listContentItem:"listContentItem___1LC6P",standardList:"standardList___2G0F0",headerInfo:"headerInfo___fTGl8",extraContentSearch:"extraContentSearch___-gpfz",listCard:"listCard___15S6J",standardListForm:"standardListForm___1nWyh",formResult:"formResult___1lwj-"}}}]);